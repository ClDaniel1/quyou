var VisitorChatRecord = function () {
    this.ada = require('../adapter');
};

VisitorChatRecord.prototype.addRecord = function (sendId,receiveId,content) {
    var sql = "insert into t_visitorchatrecord(sendId,receiveId,content,recordTime)   values(?,?,?,time(now()))";
    this.ada.run(sql,[sendId,receiveId,content],function () {

    })
};

VisitorChatRecord.prototype.getRecord = function (vistorId, callback) {
    var sql = "select * from t_visitorchatrecord where sendId=? or receiveId = ?";
    this.ada.all(sql,[vistorId,vistorId],function (res,data) {
        if(res){
            callback(res,data);
        }
        else {
            callback(res);
        }
    })
};

VisitorChatRecord.prototype.clear = function () {
    var sql = "delete from t_visitorChatRecord";
    this.ada.run(sql,[],function () {

    })
};

VisitorChatRecord.prototype.move = function (vistorId,userPhone,userName) {
    var sql = "select userImg from t_user where userPhone = ?";
    this.ada.all(sql,[userPhone],function (res,data) {
        if(res){
            var userImg = data[0].userImg;
            var sql = "select * from t_visitorChatRecord where sendId=? or receiveId = ?";
            this.ada.all(sql,[vistorId,vistorId],function (res,data) {
                if(res){
                    for(var i = 0;i<data.length;i++){
                        var sendId = data[i].sendId;
                        var receiveId = data[i].receiveId;
                        var content = JSON.parse(data[i].content);

                        if(sendId == vistorId){
                            sendId = userPhone;
                            content.sender = userPhone;
                            content.content.name = userName;
                        }
                        else if(receiveId == vistorId){
                            receiveId = userPhone;
                            content.receiver = userPhone;
                        }

                        content.headImg = userImg;
                        content.content.headImg = userImg;
                        content = JSON.stringify(content);

                        var sql = "insert into t_chatRecord(sendId,receiveId,content,recordTime)  values(?,?,?,date('now','localtime'))";
                        this.ada.run(sql,[sendId,receiveId,content],function () {

                        });
                        sql = "delete from t_visitorChatRecord where sendId=? or receiveId = ?";
                        this.ada.run(sql,[vistorId,vistorId],function () {

                        });
                    }
                }
            }.bind(this))
        }
    }.bind(this))
};

module.exports = new VisitorChatRecord();