{extend name="public/base"}
{block name='style'}
<!--页面样式、引用/示例如下-->
<!--<link rel="stylesheet" href="__CSS__/scenic/region/region.css">-->

<link rel="stylesheet" href="__STATIC__/lib/jcrop/css/jquery.Jcrop.css">
<style>
    #imgView{
        position: fixed;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 1000;
        display: none;
        text-align: center;
        padding-top: 75px;
    }
    #imgView div{
        display: inline-block;
    }
    #imgView>img{
        display: inline-block;
        max-width: 90%;
        max-height: 85%;
    }
.setting{
    width: 100%;
    height: 800px;
    background-color: #00b7ee;
}
.menuList{
    position: absolute;
    border-bottom-style:none;
    margin: 20px 100px;
    width: 200px;
    height: 300px;
}
.menuList li{
    display: table;
    /*width: 130px;*/
    height: 46px;
    text-align: center;
    font-size: 18px;

}
.menuCon{
    margin: 20px 260px;
    background-color: #fff;
    height: 800px;
    /*border: 1px solid black;*/
    /*width: 600px;*/
    /*height: 600px;*/
}
.title{
    padding-bottom: 18px;
    margin: 0 0 20px 0;
    border-bottom: 1px solid #eee;
}
.title p{
    font-size: 24px;
    color: #444;
    font-weight: normal;
}
.setTitle{
    font-size: 15px;
    color: #3f3f3f;
    width: 100px;
}
.myInfo tr td{
    padding: 20px 0;
    width: 150px;
    height: 74px;
}
.myInfo{
    margin: 0 220px;
}
.setInput{
    padding: 5px 10px;
    width: 200px;
    font-size: 15px;
    border: 1px solid #c8c8c8;
    border-radius: 4px;
    text-align: center;
    background-color: hsla(0,0%,71%,.1);
}
.myInfo tr{
    border-bottom: 1px solid #f0f0f0;
    display: table-row;
    vertical-align: inherit;
    /*border-color: inherit;*/
}
.setRadio{
    font-size: 15px;
    color: #969696;
    float: left;
}
.setRadio input{
    margin: 11px 11px;
}
.saveInfo{
    margin:0 120px;
    width: 100px;
    border-bottom: none;
    /*background-color: #F9851D;*/
}
.codeImg{
    float: left;
    width: 80px;
    height: 36px;
    border: 1px solid #b2b2b2;
    text-align: center;
    background: -webkit-gradient(linear,0 0,0 100%,from(#fff),to(#f2f2f2));
    border-radius: 4px;
    line-height: 34px;
    margin: 0 10px;
}
.codeImg p{
    color: #8e8e8e;
    font-size: 14px;
}
.uploadImg{
    margin:50px 130px;
}
#uploadBox{
    margin: 0 220px;
}

#myHead{
    width: 100px;
    height: 100px;
    border-radius: 100px;
    background-color: #00a2d4;
    margin: 20px 135px;
}

</style>
{/block}

{block name='title'}
个人中心
{/block}
{block name='first'}
<div id="imgView">
    <img id="imgShow" src="">
    <div id='btn'>
        <input type="button" value="提交" class="layui-btn navBg" id="subBI">
        <input type="button" value="取消" class="layui-btn navBg" id="escBI">
    </div>
</div>
{/block}

{block name='body'}
<!--页面内容 /示例如下-->


<div id="menuList">
    <div class="layui-tab layui-tab-brief" lay-filter="test1">
        <ul class="layui-tab-title menuList">
            <li class="layui-this" lay-id="1" >我的信息</li>
            <li lay-id="2">我的头像</li>
            <li lay-id="3">修改密码</li>
            <li lay-id="4">地址管理</li>
            <li lay-id="5">绑定设置</li>
        </ul>
        <div class="layui-tab-content menuCon">
            <div class="layui-tab-item layui-show">
                <div class="title">
                    <span class="layui-breadcrumb">
                        <a href="{:url('home/Index/index')}">首页</a>
                        <a href="{:url('home/Personal/personal')}">个人中心</a>
                        <a href="">设置中心</a>
                        <a><cite>我的信息</cite></a>
                    </span>
                    <!--<p>我的信息</p>-->
                </div>
                <table class="myInfo" id="myInfo">
                    <tr>
                        <td class="setTitle">昵称</td>
                        <td><input id="userName" class="am-form-field am-round setInput" type="text" v-bind:value="userName" placeholder="请输入昵称"></td>
                    </tr>
                    <tr>
                        <td class="setTitle">电子邮箱</td>
                        <td><input id="userEmail" class="am-form-field am-round setInput" type="text" v-bind:value="userEmail" placeholder="请输入您的常用邮箱"></td>
                    </tr>
                    <tr>
                        <td class="setTitle">性别</td>
                        <td class="setRadio" id="userSex">
                            <input type="radio" class="userSex" value="男" name="sex">男
                            <input type="radio" class="userSex" value="女" name="sex">女
                        </td>
                    </tr>
                    <tr>
                        <td class="setTitle">年龄</td>
                        <td><input id="userAge" class="am-form-field am-round setInput" type="text" v-bind:value="userAge" placeholder="请输入您的年龄"></td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <input id="saveInfo" type="button" class="layui-btn layui-btn-radius saveInfo" value="保存">
                        </td>
                    </tr>
                </table>
            </div>
            <div class="layui-tab-item">
                <div class="title">
                    <span class="layui-breadcrumb">
                        <a href="{:url('home/Index/index')}">首页</a>
                        <a href="{:url('home/Personal/personal')}">个人中心</a>
                        <a href="">设置中心</a>
                        <a><cite>我的头像</cite></a>
                    </span>
                    <!--<p>我的头像</p>-->
                </div>
                <div id="uploadBox">
                    <div id="headImg">
                        <img id="myHead" v-bind:src="headImg" alt="">
                    </div>
                    <div class="layui-upload">
                        <div class="layui-upload uploadImg">
                            <button type="button" class="layui-btn" id="upImg">
                                <i class="layui-icon">&#xe67c;</i>上传图片
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-tab-item">
                <div class="title">
                    <span class="layui-breadcrumb">
                        <a href="{:url('home/Index/index')}">首页</a>
                        <a href="{:url('home/Personal/personal')}">个人中心</a>
                        <a href="">设置中心</a>
                        <a><cite>修改登录密码</cite></a>
                    </span>
                    <!--<p>修改登录密码</p>-->
                </div>
                <table class="myInfo">
                    <tr>
                        <td class="setTitle">新密码</td>
                        <td><input id="newPwd" class="am-form-field am-round setInput" type="password" placeholder="请输入新密码"></td>
                    </tr>
                    <tr>
                        <td class="setTitle">确认密码</td>
                        <td><input id="surePwd" class="am-form-field am-round setInput" type="password" placeholder="请确认密码"></td>
                    </tr>
                    <tr>
                        <td class="setTitle">验证码</td>
                        <td><input class="am-form-field am-round setInput" type="password" placeholder="短信验证码"></td>
                        <td class="setTitle"><button class="codeImg" type="button" class="am-btn am-btn-default"><p>获取验证码</p></button></td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <input id="savePwd" type="button" class="layui-btn layui-btn-radius saveInfo" value="确认修改">
                        </td>
                    </tr>
                </table>
            </div>
            <div class="layui-tab-item">
                <div class="title">
                    <span class="layui-breadcrumb">
                        <a href="{:url('home/Index/index')}">首页</a>
                        <a href="{:url('home/Personal/personal')}">个人中心</a>
                        <a href="">设置中心</a>
                        <a><cite>地址管理</cite></a>
                    </span>
                </div>
                <div>
                    <table class="layui-table">
                        <colgroup>
                            <col width="150">
                            <col width="200">
                            <col>
                        </colgroup>
                        <thead>
                        <tr>
                            <th>昵称</th>
                            <th>加入时间</th>
                            <th>签名</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>贤心</td>
                            <td>2016-11-29</td>
                            <td>人生就像是一场修行</td>
                        </tr>
                        <tr>
                            <td>许闲心</td>
                            <td>2016-11-28</td>
                            <td>于千万人之中遇见你所遇见的人，于千万年之中，时间的无涯的荒野里…</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="layui-tab-item">
                <div class="title">
                    <span class="layui-breadcrumb">
                        <a href="{:url('home/Index/index')}">首页</a>
                        <a href="{:url('home/Personal/personal')}">个人中心</a>
                        <a href="">设置中心</a>
                        <a><cite>绑定设置</cite></a>
                    </span>
                    <!--<p>绑定设置</p>-->
                </div>

            </div>
        </div>
    </div>

</div>


<div class="am-modal am-modal-loading am-modal-no-btn" tabindex="-1" id="my-modal-loading">
    <div class="am-modal-dialog">
        <div class="am-modal-hd">头像上传中...</div>
        <div class="am-modal-bd">
            <span class="am-icon-spinner am-icon-spin"></span>
        </div>
    </div>
</div>


{/block}


{block name='script'}
<script src="__STATIC__/lib/jcrop/js/jquery.Jcrop.js"></script>
<script>
    nav(4);
</script>
<script src="__JS__/home/public/userPublic.js"></script>

<script>
var upload = layui.upload;
var jcropApi;
var $modal = $('#my-modal-loading');
//JavaScript代码区域
layui.use('element', function(){
        var element = layui.element;

        //获取hash来切换选项卡，假设当前地址的hash为lay-id对应的值
        var layid = location.hash.replace(/^#test1=/, '');
        element.tabChange('test1', layid); //假设当前地址为：http://a.com#test1=222，那么选项卡会自动切换到“发送消息”这一项

        //监听Tab切换，以改变地址hash值
        element.on('tab(test1)', function(){
            location.hash = 'test1='+ this.getAttribute('lay-id');
        });
    });
var uid = getCookie("qy_uid");
var getInfoUrl='{:url("home/Personal/getInfo")}';
//获取用户信息
$(function(){
    //获取个人信息
    $.ajax({
        type:"post",
        url:getInfoUrl,
        data:{uid:uid},
        dataType:"JSON",
        success: function (res) {
            console.log(res);
            unamedb=res.uname;
            $('#userName').val(res.uname);
            $('#userEmail').val(res.email);
            $('#userAge').val(res.uage);
//            var info=new Vue({
//                el:'#myInfo',
//                data:{
//                    userName:res.uname,
//                    userEmail:res.email,
//                    userAge:res.uage
//                }
//            });
//            var head=new Vue({
//                el:'#headImg',
//                data:{
//                    headImg:"__STATIC__/"+res.uheadImg
//                }
//            });
            $('#myHead').attr("src","__STATIC__/"+res.uheadImg);

            if(res.usex=='男'){
                $("input:radio[name='sex']").eq(0).attr("checked",true);
            }else if(res.usex=='女'){
                $("input:radio[name='sex']").eq(1).attr("checked",true);
            }else{
                $("input:radio").attr("checked",false);
            }
        }
    })
});

//修改信息
$('#saveInfo').click(function () {
    var uname=$('#userName').val();
    var email=$('#userEmail').val();
    var usex=$("input:radio[name='sex']:checked").val() ;
    var uage=$('#userAge').val();
    var changeInfoUrl='{:url("home/Personal/changeInfo")}';
    if(uname=='' || email=='' || usex==undefined || uage==''){
        layer.msg('输入不能为空', {icon: 2});

    }else if(checkUserName(uname) && checkEmail(email) && checkAge(uage)){
        $.ajax({
            type:'post',
            url:changeInfoUrl,
            data:{uid:uid,uname:uname,email:email,usex:usex,uage:uage},
            dataType:'json',
            success: function (res) {
                console.log(res);
                if(res.code==30002){
                    layer.msg(res.msg);
                }else if(res.code==30003){
                    layer.msg(res.msg);
                }else if(res.code==30001){
                    layer.msg(res.msg);
                }
            }
        })
    }
});

//修改用户密码
$('#savePwd').click(function () {
    var newPwd=$('#newPwd').val();
    var surdPwd=$('#surePwd').val();
    var changPwdUrl='{:url("home/Personal/changePwd")}';
    if(newPwd=='' || surdPwd ==''){
        layer.msg('输入不能为空');
    }else if(isPassword(newPwd) && isPassword(surdPwd) && samePwd(newPwd,surdPwd))
    {
        $.ajax({
            type:'post',
            url:changPwdUrl,
            data:{uid:uid,upwd:newPwd},
            dataType:'json',
            success: function (res) {
                console.log(res);
                if(res.code==30002){
                    layer.msg(res.msg);
                }else if(res.code==30003){
                    layer.msg(res.msg);
                }else if(res.code==30004){
                    layer.msg(res.msg);
                }
            }
        })
    }
});

//昵称重复验证
$('#userName').blur(function () {
    var uname=$('#userName').val();
    var checkNameUrl='{:url("home/User/checkName")}';
    if(unamedb==uname){
    }else{
        checkReName(checkNameUrl,uname);
    }
});

//头像上传
upload.render({
        elem: '#upImg'
        ,url: '{:url("home/Personal/upload")}'
        ,auto: false
        ,accept:"imgaes"
        ,number:1
    //,multiple: true
        ,bindAction: '#subBI'
        ,bgOpacity:0.1
        ,choose: function(obj){
    //预读本地文件示例，不支持ie8
    obj.preview(function(index, file, result){
        $('#imgShow').attr('src', result); //图片链接（base64）

        setTimeout(function () {
            var wid = document.getElementById('imgShow').naturalWidth;
            var hei = document.getElementById('imgShow').naturalHeight;
                $("#imgView").fadeIn(300,function () {

                    $('#imgShow').Jcrop({
                        allowSelect:false,
                        aspectRatio:1/1
                    }, function() {
                        jcropApi = this;
                    });
                    var size = jcropApi.getBounds();

                    var scale = wid/size[0];

                    var x = 100/scale;
                    var y = 100/scale;

                    if(size[0]>size[1]){
                        var s = size[1];
                    }
                    else {
                        var s = size[0];
                    }

                    jcropApi.setOptions({
                        setSelect:[0,0,s,s],
                        minSize:[x,y]
                    })
                });
        },300)

    });
}
,before:function () {
    $modal.modal();
    var select = jcropApi.tellSelect();
    var size = jcropApi.getBounds();
    console.log(select);
    var data = [size[0],select["x"],select["y"],select["x2"],select["y2"]];
    $.ajax({
        url: '{:url("home/Personal/upload")}',
        data:{"size":JSON.stringify(data)},
        async:false
    })
}
,done: function(res){
    $modal.modal('close');
    if(res["code"]== 50001){
        $("#aspectration div").empty();
        $img = "<img src='/quyou/public/static/"+res["data"]["url"]+"?"+Math.random()+"'/>";
        $("#aspectration div").append($img);
        layer.msg("头像上传成功");
        $("#imgView").fadeOut(300,function () {
            jcropApi.destroy();
        });
        window.location.reload();
    }
    else{
        layer.open({
            content:res["msg"],
            yes: function(index, layero){
                //do something
                $("#imgView").fadeOut(300,function () {
                    jcropApi.destroy();
                });
                layer.close(index); //如果设定了yes回调，需进行手工关闭
            }
        });
    }
}
});
//取消上传
$("#escBI").click(function () {
    $("#imgView").fadeOut(300,function () {
        jcropApi.destroy();
    })
});

</script>
<!--JS、引用 /示例如下-->
{/block}